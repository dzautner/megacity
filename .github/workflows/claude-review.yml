name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: startsWith(github.head_ref, 'claude/')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev pkg-config libwayland-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: "claude-sonnet-4-5-20250929"
          prompt: |
            Review this PR thoroughly. It was created by an AI agent implementing a GitHub issue.

            Steps:
            1. Read CLAUDE.md for project conventions
            2. Read the linked issue to understand the requirements
            3. Review the diff in context of the surrounding codebase
            4. Check for:
               - Correctness: does the implementation match the issue requirements?
               - Bevy/ECS patterns: are components, systems, resources used correctly?
               - Performance: any unnecessary iterations, missing spatial indexing?
               - Grid consistency: respects 256x256 grid, CELL_SIZE=16.0, CHUNK_SIZE=8?
               - Road system: uses RoadSegmentStore as source of truth if touching roads?
               - Save system: are new components/resources serialized?
               - Edge cases: grid boundaries, empty collections, missing error handling?
               - No unrelated files or accidental changes included
            5. Post inline comments on specific issues
            6. Approve if it looks good, or request changes with clear instructions
